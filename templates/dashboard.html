<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="dashboard-body">
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div>
                <h1>üìä Query Dashboard</h1>
                <p>A Summary | System Interaction</p>
            </div>
            <div class="header-actions">
                <button id="themeBtn" class="theme-btn" title="Darl/White Tema">üåô</button>
                <a href="/tutorial" class="back-btn">üìñ Features</a>
                <a href="/" class="back-btn">‚Üê Go Back To Chit Chat!</a>
            </div>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-title">All Reports</div>
                <div class="stat-value" id="statTotalReports">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Processed</div>
                <div class="stat-value" id="statProcessedReports">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Pending</div>
                <div class="stat-value" id="statPendingReports">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Open Tickets</div>
                <div class="stat-value" id="statOpenTickets">-</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="grid-item">
                <h2>Support Tickets</h2>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Departman</th>
                                <th>Explanation</th>
                                <th>Status</th>
                                <th>Process</th>
                            </tr>
                        </thead>
                        <tbody id="supportTicketsTable">
    
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grid-item">
                <h2>Uploaded Reports</h2>
                <div class="table-wrapper">
                    <button id="deleteAllBtn" class="delete-btn" style="margin-bottom:10px;">Delete All</button>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Folder Name</th>
                                <th>Uploaded By</th>
                                <th>Upload Date</th>
                                <th>Download</th>
                                <th>Delete</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTable">
                          
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grid-item grid-item-full-width">
                <h2>Query History</h2>
                 <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>User Message</th>
                                <th>Bot Response</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                        
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tema Y√∂netimi
        document.addEventListener('DOMContentLoaded', function() {
            const themeBtn = document.getElementById('themeBtn');
            const body = document.body;

            function setDark(dark) {
                if (dark) {
                    body.classList.add('dark');
                    themeBtn.textContent = '‚òÄÔ∏è';
                    localStorage.setItem('theme', 'dark');
                } else {
                    body.classList.remove('dark');
                    themeBtn.textContent = 'üåô';
                    localStorage.setItem('theme', 'light');
                }
            }

            let isDark = localStorage.getItem('theme') === 'dark';
            setDark(isDark);

            themeBtn.onclick = function() {
                isDark = !isDark;
                setDark(isDark);
            };
        });

     
        document.addEventListener('DOMContentLoaded', async function() {
            try {
            
                const supportResponse = await fetch('/api/support_tickets');
                const supportTickets = await supportResponse.json();
                const supportTableBody = document.getElementById('supportTicketsTable');
                supportTableBody.innerHTML = ''; 
                if (supportTickets.length === 0) {
                     supportTableBody.innerHTML = '<tr><td colspan="5">There is no support ticket to display.</td></tr>';
                } else {
                    supportTickets.forEach(ticket => {
                        const row = `<tr>
                            <td>${ticket.ticket_id.substring(0, 8)}</td>
                            <td>${ticket.department}</td>
                            <td class="description-cell">${ticket.description}</td>
                            <td><span class="status-badge status-${ticket.status.toLowerCase()}">${ticket.status}</span></td>
                            <td>${new Date(ticket.created_at).toLocaleString('tr-TR')}</td>
                        </tr>`;
                        supportTableBody.innerHTML += row;
                    });
                }

                const reportsResponse = await fetch('/reports');
                const reports = await reportsResponse.json();
                const reportsTableBody = document.getElementById('reportsTable');
                reportsTableBody.innerHTML = '';
                if (reports.length === 0) {
                    reportsTableBody.innerHTML = '<tr><td colspan="4">No report yet.<td></tr>';
                } else {
                    reports.forEach(report => {
                        const row = `<tr id="report-row-${report.id}">
                            <td>#${report.id}</td>
                            <td>${report.original_filename}</td>
                            <td>${report.uploader_name}</td>
                            <td>${new Date(report.created_at).toLocaleString('tr-TR')}</td>
                            <td><a href="/download_report/${report.stored_filename}" class="download-link">ƒ∞ndir</a></td>
                            <td><button onclick="deleteReport(${report.id})" class="delete-btn">Delete</button></td>
                        </tr>`;
                        reportsTableBody.innerHTML += row;
                    });
                }
                
           
                const historyResponse = await fetch('/api/history');
                const history = await historyResponse.json();
                const historyTableBody = document.getElementById('historyTable');
                historyTableBody.innerHTML = ''; 
               
                try {
                    const dash = await fetch('/api/issues').then(r => r.json());
                    if (dash && dash.reports) {
                        document.getElementById('statTotalReports').textContent = dash.reports.total ?? '-';
                        document.getElementById('statProcessedReports').textContent = dash.reports.processed ?? '-';
                        document.getElementById('statPendingReports').textContent = dash.reports.unprocessed ?? '-';
                    }
                    if (dash && dash.tickets && dash.tickets.by_status) {
                        const open = dash.tickets.by_status.open || 0;
                        document.getElementById('statOpenTickets').textContent = open;
                    }
                } catch (e) {
                    print(e)
                }
                 if (history.length === 0) {
                    historyTableBody.innerHTML = '<tr><td colspan="4">There is no query yet.</td></tr>';
                } else {
                    history.forEach(item => {
                        const row = `<tr>
                            <td>${item.type}</td>
                            <td class="description-cell">${item.user_message}</td>
                            <td class="description-cell">${item.bot_response}</td>
                            <td>${new Date(item.timestamp).toLocaleString('tr-TR')}</td>
                        </tr>`;
                        historyTableBody.innerHTML += row;
                    });
                }

            } catch (error) {
                console.error("An error occur while tried to load dashboard data:", error);
                document.getElementById('reportsTable').innerHTML = '<tr><td colspan="4">Data Couldnt Processed.<td></tr>';
                document.getElementById('supportTicketsTable').innerHTML = '<tr><td colspan="5">Data Couldnt Loaded.</td></tr>';
                document.getElementById('historyTable').innerHTML = '<tr><td colspan="4">Data/Query History Couldnt Loaded.</td></tr>';
            }
        });

        async function deleteReport(reportId) {
            if (!confirm("Are you sure do you want to delete this report forever?")) {
                return;
            }
            try {
                const response = await fetch(`/delete_report/${reportId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                  
                    const row = document.getElementById(`report-row-${reportId}`);
                    if (row) {
                        row.remove();
                    }
                    alert('Rapor deleted successfully.');
                } else {
                    alert(`Hata: ${result.message}`);
                }
            } catch (error) {
                console.error("Report error occured:", error);
                alert("An error occured in network connection.");
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            if (deleteAllBtn) {
                deleteAllBtn.onclick = async function() {
                    if (!confirm("Are you sure you want to delete all reports and related data forever?")) return;
                    try {
                        const response = await fetch('/delete_all_reports', { method: 'DELETE' });
                        const result = await response.json();
                        if (result.success) {
                      
                            document.getElementById('reportsTable').innerHTML = '<tr><td colspan="4">There is no report yet.<td></tr>';
                            alert('All reports and related data has been deleted successfully.');
                        } else {
                            alert('Error: ' + result.message);
                        }
                    } catch (error) {
                        alert('A error occured in deleting process.');
                    }
                }
            }
        });
    </script>
</body>
</html>
